desc: Deployment Verification Script
labels:
  - deployment
  - production
vars:
  PROD_URL: https://production.example.com
  HEALTH_ENDPOINT: /health
  VERSION_ENDPOINT: /api/version
steps:
  - desc: Check production health
    req:
      ${PROD_URL}${HEALTH_ENDPOINT}:
        get:
    test: |
      current.res.status == 200
  
  - desc: Verify deployment version
    req:
      ${PROD_URL}${VERSION_ENDPOINT}:
        get:
    test: |
      current.res.body.version matches "^v\\d+\\.\\d+\\.\\d+"
    bind:
      deployedVersion: current.res.body.version
  
  - desc: Run smoke tests
    runner: smoketest
    steps:
      - desc: Test critical endpoints
        req:
          ${PROD_URL}/api/products:
            get:
        test: |
          current.res.status == 200 &&
          len(current.res.body) > 0
  
  - desc: Log deployment success
    exec:
      command: |
        echo "Deployment verified: ${deployedVersion}"